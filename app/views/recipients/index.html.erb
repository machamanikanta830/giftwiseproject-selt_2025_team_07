<div class="min-h-screen bg-[#f5f5fb] text-gray-900">

  <header class="w-full bg-white shadow-sm">
    <div class="max-w-6xl mx-auto flex items-center justify-between px-6 py-4">

      <%= link_to(current_user.present? ? dashboard_path : root_path,
                  class: "flex items-center gap-2 hover:opacity-90 transition") do %>
        <div class="w-9 h-9 rounded-2xl bg-[#f4e6ff] flex items-center justify-center">

          <svg xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 24 24"
               class="w-6 h-6 text-[#a855f7]"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round">
            <rect x="3" y="8" width="18" height="13" rx="2" ry="2"></rect>
            <path d="M12 8v13"></path>
            <path d="M3 12h18"></path>
            <path d="M12 8h4a2 2 0 0 0 0-4c-3 0-4 4-4 4z"></path>
            <path d="M12 8H8a2 2 0 0 1 0-4c3 0 4 4 4 4z"></path>
          </svg>
        </div>
        <span class="text-xl font-semibold tracking-tight">GiftWise</span>
      <% end %>

      <nav class="flex items-center gap-4 text-sm font-medium">

        <div class="relative" data-controller="dropdown">

          <button
            type="button"
            data-action="click->dropdown#toggle"
            class="w-9 h-9 rounded-full bg-[#f4e6ff] flex items-center justify-center
                   hover:bg-[#e9d5ff] transition shadow-sm"
          >
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24"
                 class="w-5 h-5 text-[#a855f7]"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
              <circle cx="12" cy="8" r="3"></circle>
              <path d="M6 19c0-3 2.5-5 6-5s6 2 6 5"></path>
            </svg>
          </button>

          <div
            data-dropdown-target="menu"
            class="hidden absolute left-0 mt-3 w-64 origin-top-left rounded-2xl bg-white
                   shadow-lg border border-gray-200 py-2 z-50"
          >

            <div class="px-4 pb-2 border-b border-gray-100 mb-2">
              <p class="text-sm font-semibold text-gray-900 truncate">
                <%= current_user.name %>
              </p>
              <% if current_user.respond_to?(:email) && current_user.email.present? %>
                <p class="text-xs text-gray-500 truncate">
                  <%= current_user.email %>
                </p>
              <% end %>
            </div>

            <%= link_to "Edit Profile",
                        edit_profile_path,
                        class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap" %>

            <%= link_to "Change password",
                        edit_password_path,
                        class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap" %>

            <div class="mt-2 pt-2 border-t border-gray-100">
              <%= button_to "Log Out",
                            logout_path,
                            method: :delete,
                            class: "w-full text-left px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 whitespace-nowrap" %>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-10 pb-24">

    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-4">
        <%= link_to "← Back to Dashboard",
                    dashboard_path,
                    class: "inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 hover:bg-gray-100" %>
        <h1 class="text-3xl font-semibold">Recipients</h1>
      </div>

      <%= link_to "+ New Recipient",
                  new_recipient_path,
                  class: "inline-flex items-center gap-2 px-4 py-2 rounded-full bg-[#a855f7] text-white text-sm font-medium hover:bg-[#9333ea] transition" %>
    </div>

    <div class="mb-5">
      <%= form_with url: recipients_path, method: :get, local: true, class: "max-w-xl" do |f| %>
        <div
          class="flex items-center rounded-2xl border border-gray-300 bg-white px-4 py-2.5
                 focus-within:ring-2 focus-within:ring-[#a855f7] focus-within:border-transparent"
        >

          <%= f.text_field :query,
                           value: @query,
                           class: "w-full bg-transparent border-none outline-none focus:ring-0 text-sm",
                           placeholder: "Search by name, email, or relationship..." %>

          <button
            type="submit"
            class="ml-2 flex items-center justify-center"
            aria-label="Search"
          >
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24"
                 class="w-4 h-4 text-gray-400"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
              <circle cx="11" cy="11" r="7"></circle>
              <line x1="16.5" y1="16.5" x2="20" y2="20"></line>
            </svg>
          </button>
        </div>
      <% end %>
    </div>

    <div class="bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left font-medium text-gray-500">Name</th>
          <th class="px-6 py-3 text-left font-medium text-gray-500">Email</th>
          <th class="px-6 py-3 text-left font-medium text-gray-500">Relationship</th>
          <th class="px-6 py-3 text-right font-medium text-gray-500">Actions</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
        <% @recipients.each do |recipient| %>

          <tr class="hover:bg-purple-50 cursor-pointer"
              onclick="window.location.href='<%= recipient_path(recipient) %>'">
            <td class="px-6 py-3 text-gray-900"><%= recipient.name %></td>
            <td class="px-6 py-3 text-gray-600"><%= recipient.email.presence || "—" %></td>
            <td class="px-6 py-3 text-gray-600"><%= recipient.relationship.presence || "—" %></td>
            <td class="px-6 py-3 text-right whitespace-nowrap">

              <!-- Gift Idea -->
              <% if recipient.events.exists? %>
                <%= link_to "Gift Idea",
                            new_recipient_gift_idea_path(recipient),
                            data: { turbo: false },
                            class: "inline-flex items-center rounded-full border border-indigo-500 px-3 py-1 text-xs font-medium text-indigo-600 hover:bg-indigo-50 mr-2",
                            onclick: "event.stopPropagation();" %>
              <% else %>
                <%= button_tag "Gift Idea",
                               class: "inline-flex items-center rounded-full border border-gray-300 px-3 py-1 text-xs font-medium text-gray-400 bg-gray-100 cursor-not-allowed mr-2",
                               disabled: true %>
              <% end %>

              <!-- Gift Given -->
              <%= link_to "Gift Given",
                          new_recipient_gift_given_backlog_path(recipient),
                          data: { turbo: false },
                          class: "inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-100 mr-2",
                          onclick: "event.stopPropagation();" %>

              <!-- Edit -->
              <%= link_to "Edit",
                          edit_recipient_path(recipient),
                          class: "inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-100 mr-2",
                          onclick: "event.stopPropagation();" %>

              <!-- Remove -->
              <%= button_to "Remove",
                            recipient_path(recipient),
                            method: :delete,
                            form: { class: "inline-block" },
                            class: "inline-flex items-center rounded-full border border-red-200 px-3 py-1 text-xs font-medium text-red-600 hover:bg-red-50",
                            onclick: "event.stopPropagation();" %>

            </td>

          </tr>
        <% end %>

        <% if @recipients.empty? %>
          <tr>
            <td colspan="4" class="px-6 py-6 text-center text-gray-500">
              No recipients yet. Click "New Recipient" to add one.
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </main>

  <div class="fixed bottom-8 right-8">
    <%= link_to "+",
                new_recipient_path,
                class: "inline-flex items-center justify-center w-14 h-14 rounded-full bg-[#a855f7] text-white text-2xl font-semibold shadow-lg hover:bg-[#9333ea] transition",
                title: "Add Recipient" %>
  </div>
</div>
