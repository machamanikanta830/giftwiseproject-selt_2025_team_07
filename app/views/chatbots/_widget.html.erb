<%# app/views/chatbots/_widget.html.erb %>
<div data-controller="chatbot">
  <!-- Floating chatbot button (bottom-right) -->
  <button
    type="button"
    data-chatbot-target="toggleButton"
    data-action="click->chatbot#toggle"
    style="
    position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      width: 56px;
      height: 56px;
      border-radius: 9999px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      transition: transform 0.15s ease-out;
    "
    onmouseover="this.style.transform='scale(1.06)'"
    onmouseout="this.style.transform='scale(1)'"
  >
    <img src="/assets/chatbot.png" alt="Chatbot" style="width: 40px; height: 40px;">
  </button>

  <!-- Slide-in sidebar panel (right side) -->
  <div
    data-chatbot-target="panel"
    style="
    position: fixed;
      bottom: 96px;
      right: 24px;
      width: 360px;
      max-height: 480px;
      background: #f9fafb;
      border-radius: 24px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 45px rgba(15,23,42,0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateX(120%);
      pointer-events: none;
      transition: transform 0.2s ease-out, opacity 0.2s ease-out;
      z-index: 9999;
    "
  >
    <!-- Header -->
    <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #e5e7eb; background:#ffffff;">
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="width:32px; height:32px; border-radius:16px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
          <img src="/assets/chatbot.png" alt="Bot" style="width:22px; height:22px;">
        </div>
        <div>
          <p style="margin:0; font-size:13px; font-weight:600; color:#111827;">GiftWise Assistant</p>
          <p style="margin:0; font-size:11px; color:#6b7280;">Ask about events, recipients & wishlist</p>
        </div>
      </div>

      <div style="display:flex; align-items:center; gap:6px; color:#9ca3af; font-size:11px;">
        <!-- Reload conversation -->
        <button
          type="button"
          title="Restart conversation"
          data-action="click->chatbot#resetConversation"
          style="border:none; background:transparent; cursor:pointer; color:inherit;"
        >
          âŸ³
        </button>

        <!-- Exit session -->
        <button
          type="button"
          title="Exit session"
          data-action="click->chatbot#exitSession"
          style="
          border-radius:9999px;
            border:1px solid #e5e7eb;
            padding:2px 8px;
            background:#f9fafb;
            cursor:pointer;
            color:#6b7280;
          "
        >
          Exit
        </button>

        <!-- Close panel -->
        <button
          type="button"
          title="Close"
          data-action="click->chatbot#closePanel"
          style="border:none; background:transparent; cursor:pointer; font-size:13px; color:#6b7280;"
        >
          âœ•
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div
      data-chatbot-target="messages"
      style="
      padding: 8px 10px 4px 10px;
        overflow-y: auto;
        max-height: 320px;
        font-size: 13px;
      "
    >
      <% history = (session[:chatbot_history] || []) %>
      <% if history.any? %>
        <% history.each do |msg| %>
          <% if msg["role"] == "bot" %>
            <div style="display:flex; justify-content:flex-start; margin-bottom:6px;">
              <div style="max-width:80%; background:#ffffff; color:#111827; border-radius:16px; padding:6px 9px; border:1px solid #e5e7eb; white-space:pre-wrap;">
                <%= msg["text"] %>
              </div>
            </div>
          <% else %>
            <div style="display:flex; justify-content:flex-end; margin-bottom:6px;">
              <div style="max-width:80%; background:#a855f7; color:#ffffff; border-radius:16px; padding:6px 9px; white-space:pre-wrap;">
                <%= msg["text"] %>
              </div>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div style="display:flex; justify-content:flex-start; margin-bottom:6px;">
          <div style="max-width:80%; background:#ffffff; color:#111827; border-radius:16px; padding:6px 9px; border:1px solid #e5e7eb; white-space:pre-wrap;">
            Hi there! ðŸ‘‹ I'm your GiftWise Assistant.
            Ask me about upcoming events, recipients, budgets or wishlist â€” or tap a suggested question below.
          </div>
        </div>
      <% end %>
    </div>

    <!-- Quick replies -->
    <div
      data-chatbot-target="quickReplies"
      style="padding: 0 10px 6px 10px; display:flex; flex-wrap:wrap;"
    >
      <%# JS fills this from /chatbot/message %>
    </div>

    <!-- Input -->
    <form
      data-chatbot-target="form"
      data-action="submit->chatbot#send"
      style="border-top:1px solid #e5e7eb; padding:6px 8px; background:#ffffff; display:flex; align-items:center; gap:6px;"
    >
      <input
        type="text"
        placeholder="Ask about events, recipients, or wishlistâ€¦"
        data-chatbot-target="input"
        style="
        flex:1;
          font-size:13px;
          padding:6px 10px;
          border-radius:9999px;
          border:1px solid #d1d5db;
          outline:none;
        "
      >
      <button
        type="submit"
        style="
        padding:6px 10px;
          border-radius:9999px;
          border:none;
          background:#a855f7;
          color:#ffffff;
          font-size:12px;
          font-weight:500;
          cursor:pointer;
        "
      >
        Send
      </button>
    </form>
  </div>
</div>
