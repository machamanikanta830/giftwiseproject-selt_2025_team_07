<div class="min-h-screen bg-[#f5f5fb] text-gray-900">



  <main class="max-w-6xl mx-auto px-6 pt-10 pb-16">
    <% back_path, back_label =
         case params[:from]
         when "events_index"
           [events_path, "Back to All Events"]
         when "dashboard"
           [dashboard_path, "Back to Dashboard"]
         when "event"
           [event_path(@event), "Back to Event"]
         else
           [dashboard_path, "Back"]
         end %>

    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <%= link_to back_label,
                    back_path,
                    class: "inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 hover:bg-gray-100" %>

        <div>
          <h1 class="text-2xl font-semibold">AI Gift Ideas</h1>
          <p class="text-sm text-gray-500">
            <%= @event.event_name %>
            <% if @event.event_date.present? %>
              • <%= @event.event_date.strftime("%b %d, %Y") %>
            <% end %>
            <% if @event.budget.present? %>
              • Budget: <%= number_to_currency(@event.budget, precision: 0) %>
            <% end %>
          </p>
        </div>
      </div>
    </div>

    <% if @recipients.empty? %>
      <div class="bg-white rounded-3xl border border-dashed border-gray-300 px-6 py-8 text-center text-sm text-gray-500 mb-8">
        This event has no recipients yet. Add at least one recipient to generate AI ideas.
      </div>
    <% end %>

    <div class="space-y-6">
      <% @recipients.each do |recipient| %>
        <% all_suggestions = @suggestions_by_recipient[recipient.id] || [] %>
        <% regenerate_suggestions = all_suggestions.select { |s| s.round_type == "regenerate" } %>
        <% suggestions = regenerate_suggestions.presence || all_suggestions %>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-200 p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="font-semibold text-lg"><%= recipient.name %></h2>
              <p class="text-sm text-gray-500">
                <%= recipient.relationship.presence || "Recipient" %>
                <% if recipient.hobbies.present? %>
                  • Hobbies: <%= truncate(recipient.hobbies, length: 80) %>
                <% end %>
              </p>
            </div>

            <% has_suggestions = suggestions.any? %>
            <%= button_to event_ai_gift_suggestions_path(@event,
                                                         recipient_id: recipient.id,
                                                         round_type: (has_suggestions ? "regenerate" : "initial"),
                                                         from: params[:from]),
                          method: :post,
                          class: "inline-flex items-center px-4 py-2 rounded-full bg-[#a855f7] text-white text-sm font-medium hover:bg-[#9333ea] transition" do %>
              <% if has_suggestions %>
                <span class="mr-1">↻</span>
                <span>Regenerate ideas</span>
              <% else %>
                <span class="mr-1">✨</span>
                <span>Generate Ideas</span>
              <% end %>
            <% end %>
          </div>

          <% if suggestions.any? %>
            <!-- FIVE clean cards per row with consistent square images -->
            <div class="grid grid-cols-5 auto-cols-fr gap-3 mt-3" style="grid-template-columns: repeat(5, minmax(0, 1fr));">
              <% suggestions.first(5).each do |idea| %>
                <div class="ai-gift-card border border-gray-100 rounded-2xl overflow-hidden bg-gray-50 flex flex-col h-full">
                  <% if idea.image_url.present? %>
                    <img src="<%= idea.image_url %>"
                         alt="<%= idea.title %>"
                         class="w-full h-32 object-cover">
                  <% end %>

                  <div class="p-3 flex flex-col flex-1">
                    <h3 class="font-semibold text-sm mb-1"><%= idea.title %></h3>
                    <p class="text-xs text-gray-600 mb-2 flex-1">
                      <%= truncate(idea.description.to_s, length: 120) %>
                    </p>
                    <p class="text-[11px] text-gray-500 leading-snug mb-3">
                      <% if idea.category.present? %>
                        <strong>Category:</strong> <%= idea.category %><br>
                      <% end %>
                      <% if idea.estimated_price.present? %>
                        <strong>Est. price:</strong> <%= idea.estimated_price %><br>
                      <% end %>
                      <% if idea.special_notes.present? %>
                        <strong>Notes:</strong> <%= truncate(idea.special_notes, length: 80) %>
                      <% end %>
                    </p>

                    <div class="flex items-center justify-between mt-auto">

                      <!-- ADD TO CART BUTTON (NEW) -->
                      <%= button_to cart_items_path(ai_gift_suggestion_id: idea.id),
                                    method: :post,
                                    class: "inline-flex items-center gap-1 text-xs text-gray-700 hover:text-[#a855f7]",
                                    form: { data: { turbo: "false" } } do %>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                             class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="9" cy="21" r="1"></circle>
                          <circle cx="20" cy="21" r="1"></circle>
                          <path d="M1 1h4l2.7 13.4a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6L23 6H6"></path>
                        </svg>
                        <span>Add to cart</span>
                      <% end %>









                      <% saved_for_current_user = idea.saved_for_user?(@event.user) %>

                      <% if saved_for_current_user %>
                        <%= button_to toggle_wishlist_event_ai_gift_suggestion_path(@event, idea),
                                      method: :post,
                                      params: { from: params[:from] },
                                      class: "inline-flex items-center gap-1 text-xs text-red-500 hover:text-red-600",
                                      form: { data: { turbo: "false" } } do %>
                          <svg xmlns="http://www.w3.org/2000/svg"
                               viewBox="0 0 24 24"
                               class="w-4 h-4"
                               fill="currentColor"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round">
                            <path d="M20.8 5.5a5.5 5.5 0 0 0-7.8 0L12 6.5l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-6.7 1-1a5.5 5.5 0 0 0 0-7.8z"></path>
                          </svg>
                          <span>In wishlist</span>
                        <% end %>
                      <% else %>
                        <%= button_to toggle_wishlist_event_ai_gift_suggestion_path(@event, idea),
                                      method: :post,
                                      params: { from: params[:from] },
                                      class: "inline-flex items-center gap-1 text-xs text-gray-500 hover:text-red-500",
                                      form: { data: { turbo: "false" } } do %>
                          <svg xmlns="http://www.w3.org/2000/svg"
                               viewBox="0 0 24 24"
                               class="w-4 h-4"
                               fill="none"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round">
                            <path d="M20.8 5.5a5.5 5.5 0 0 0-7.8 0L12 6.5l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-6.7 1-1a5.5 5.5 0 0 0 0-7.8z"></path>
                          </svg>
                          <span>Add to wishlist</span>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-gray-400 mt-2">
              No AI ideas yet. Click "Generate Ideas" to get suggestions for <%= recipient.name %>.
            </p>
          <% end %>
        </div>
      <% end %>
    </div>
  </main>
</div>