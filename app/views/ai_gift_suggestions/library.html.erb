<div class="min-h-screen bg-[#f5f5fb] text-gray-900">


  <main class="max-w-6xl mx-auto px-6 pt-10 pb-16">
    <!-- Page header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-semibold">AI Gift Library</h1>
        <p class="text-sm text-gray-500 mt-1">
          Browse all AI-generated gift ideas across your events and recipients.
        </p>
      </div>
    </div>

    <!-- Filters card -->
    <!-- Filters card -->
    <section class="bg-white rounded-3xl border border-gray-200 px-6 py-4 md:px-8 md:py-5 mb-8 shadow-sm">
      <%# Scope switch: Mine / Collab / All %>
      <div class="flex items-center justify-between mb-4">
        <p class="text-xs text-gray-500">
          <% current_scope = @scope.presence || "mine" %>
          <% label =
               case current_scope
               when "collab" then "ideas from collaboration events"
               when "all"    then "all ideas on events you can access"
               else              "ideas you generated"
               end %>
          Showing <span class="font-semibold"><%= label %></span>.
        </p>

        <div class="inline-flex rounded-full bg-gray-100 p-1 text-xs font-medium">
          <% base_params = request.query_parameters.except(:scope) %>

          <% [["mine", "Mine"],
              ["collab", "Collab"],
              ["all", "All"]].each do |value, text| %>
            <% active = (current_scope == value) %>
            <%= link_to text,
                        ai_gift_library_path(base_params.merge(scope: value)),
                        class: "px-3 py-1 rounded-full transition #{active ? 'bg-white shadow-sm text-[#a855f7]' : 'text-gray-500 hover:text-gray-800'}" %>
          <% end %>
        </div>
      </div>

      <%= form_with url: ai_gift_library_path, method: :get, local: true, html: { id: "ai-library-filter-form" },
                    class: "grid gap-4 md:gap-5 md:grid-cols-3" do |f| %>
        <%= hidden_field_tag :scope, current_scope %>

        <!-- Column 1: Event + Category -->
        <div class="rounded-2xl border border-gray-200 px-4 py-3 space-y-3">
          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">
              Event
            </label>
            <%= f.select :event_id,
                         options_for_select(
                           [["All events", ""]] +
                           @events.map { |e| ["#{e.event_name} (#{e.event_date&.strftime('%b %d')})", e.id] },
                           @selected_event_id
                         ),
                         {},
                         class: "w-full rounded-xl border-gray-300 text-sm focus:ring-[#a855f7] focus:border-[#a855f7]" %>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">
              Category
            </label>
            <% categories = AiGiftSuggestion
              .where(event_id: @events.select(:id))
              .where.not(category: [nil, ""])
              .distinct
              .pluck(:category) %>
            <%= f.select :category,
                         options_for_select(
                           [["All categories", ""]] + categories.map { |c| [c, c] },
                           @selected_category
                         ),
                         {},
                         class: "w-full rounded-xl border-gray-300 text-sm focus:ring-[#a855f7] focus:border-[#a855f7]" %>
          </div>
        </div>

        <!-- Column 2: Recipient + Saved only -->
        <div class="rounded-2xl border border-gray-200 px-4 py-3 space-y-3">
          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">
              Recipient
            </label>
            <%= f.select :recipient_id,
                         options_for_select(
                           [["All recipients", ""]] + @recipients.map { |r| [r.name, r.id] },
                           @selected_recipient_id
                         ),
                         {},
                         class: "w-full rounded-xl border-gray-300 text-sm focus:ring-[#a855f7] focus:border-[#a855f7]" %>
          </div>

          <div class="flex items-center">
            <%= f.label :saved_only,
                        class: "inline-flex items-center gap-2 cursor-pointer text-xs font-medium text-gray-700" do %>
              <%= f.check_box :saved_only,
                              { class: "rounded border-gray-300 text-[#a855f7] focus:ring-[#a855f7]" },
                              "1",
                              "0" %>
              Saved to wishlist only
            <% end %>
          </div>
        </div>

        <!-- Column 3: Sort + Apply -->
        <div class="rounded-2xl border border-gray-200 px-4 py-3 flex flex-col gap-3">
          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">
              Sort
            </label>
            <%= f.select :sort,
                         options_for_select(
                           [["Newest first", "newest"], ["Oldest first", "oldest"]],
                           @sort
                         ),
                         {},
                         class: "w-full rounded-xl border-gray-300 text-sm focus:ring-[#a855f7] focus:border-[#a855f7]" %>
          </div>

          <div class="mt-auto flex justify-start md:justify-end">
            <%= f.submit "Apply filters",
                         class: "inline-flex items-center justify-center px-6 py-2.5 rounded-full bg-[#a855f7] text-white text-sm font-medium hover:bg-[#9333ea] transition w-full md:w-auto" %>
          </div>
        </div>

      <% end %>
    </section>


    <!-- Suggestions grid -->
    <% if @suggestions.any? %>
      <section>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">
            <%= pluralize(@suggestions.size, "AI gift idea") %>
          </h2>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <% @suggestions.each do |suggestion| %>
            <div class="bg-white rounded-3xl border border-gray-200 p-4 flex flex-col justify-between shadow-sm">
              <div class="flex gap-4">
                <% if suggestion.image_url.present? %>
                  <div class="w-20 h-20 rounded-2xl overflow-hidden bg-gray-100 flex-shrink-0">
                    <img src="<%= suggestion.image_url %>"
                         alt="<%= suggestion.title %>"
                         class="w-full h-full object-cover" />
                  </div>
                <% else %>
                  <div class="w-20 h-20 rounded-2xl bg-[#f4e6ff] flex items-center justify-center flex-shrink-0">
                    <span class="text-xs text-[#a855f7] font-semibold">AI</span>
                  </div>
                <% end %>

                <div class="flex-1">
                  <p class="text-sm font-semibold text-gray-900 mb-1">
                    <%= suggestion.title %>
                  </p>
                  <p class="text-xs text-gray-600 mb-2 line-clamp-3">
                    <%= suggestion.description.presence || "No description provided." %>
                  </p>

                  <div class="flex flex-wrap gap-2 text-[11px] text-gray-500">
                    <!-- Event pill -->
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-50 border border-gray-200">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           viewBox="0 0 24 24"
                           class="w-3 h-3 text-[#a855f7]"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <%= suggestion.event&.event_name || "Unknown event" %>
                    </span>

                    <!-- Recipient pill -->
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-50 border border-gray-200">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           viewBox="0 0 24 24"
                           class="w-3 h-3 text-[#a855f7]"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <circle cx="12" cy="8" r="3"></circle>
                        <path d="M6 19c0-3 2.5-5 6-5s6 2 6 5"></path>
                      </svg>
                      <%= suggestion.recipient&.name || "Unknown recipient" %>
                    </span>

                    <% if suggestion.category.present? %>
                      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-50 border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 24 24"
                             class="w-3 h-3 text-[#a855f7]"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round">
                          <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                          <path d="M7 3h10a2 2 0 0 1 2 2v2"></path>
                          <path d="M21 7v10a2 2 0 0 1-2 2h-2"></path>
                          <path d="M17 21H7a2 2 0 0 1-2-2v-2"></path>
                          <path d="M7 7l10 10"></path>
                        </svg>
                        <%= suggestion.category %>
                      </span>
                    <% end %>

                    <% if suggestion.estimated_price.present? %>
                      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-50 border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 24 24"
                             class="w-3 h-3 text-[#a855f7]"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round">
                          <path d="M12 1v22"></path>
                          <path d="M8 5h4.5a3.5 3.5 0 0 1 0 7H10"></path>
                          <path d="M10 12H8.5a3.5 3.5 0 0 0 0 7H14"></path>
                        </svg>
                        <%= suggestion.estimated_price %>
                      </span>
                    <% end %>
                  </div>
                </div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <%= link_to event_path(suggestion.event, from: "ai_library"),
                            class: "text-xs font-medium text-[#a855f7] hover:text-[#9333ea] underline-offset-2 hover:underline" do %>
                  Go to event
                <% end %>

                <%= button_to toggle_wishlist_event_ai_gift_suggestion_path(suggestion.event, suggestion, from: "ai_library"),
                              method: :post,
                              form: { data: { turbo: "false" } },
                              class: "inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-200 hover:bg-[#fee2e2] transition",
                              title: (suggestion.saved_for_user?(current_user) ? "Remove from wishlist" : "Save to wishlist") do %>
                  <% if suggestion.saved_for_user?(current_user) %>
                    <span class="text-red-500 text-lg leading-none">♥</span>
                  <% else %>
                    <span class="text-gray-400 text-lg leading-none">♡</span>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </section>
    <% else %>
      <section>
        <div class="bg-white rounded-3xl border border-dashed border-gray-300 px-6 py-8 text-center text-sm text-gray-500">
          No AI gift ideas yet. Go to your
          <%= link_to "events", events_path, class: "text-[#a855f7] hover:text-[#9333ea] underline-offset-2 hover:underline" %>
          and click <span class="font-semibold">Get Ideas</span> to start generating suggestions.
        </div>
      </section>
    <% end %>
  </main>
</div>
